<?php

/**
 * @file
 * Contains functional hooks used by the CU Boulder User Invite module.
 */

use Drupal\Core\Url;

/**
 * This function contains templating code for email messages.
 *
 * Implements hook_mail().
 */
function ucb_user_invite_mail($key, &$message, $params) {
  $config = \Drupal::configFactory()->get($params['config_name']);
  $template = $config->get($key . '_template');
  if ($template) {
    $tokenService = \Drupal::token();
    $tokens = [];
    $options = ['langcode' => $message['langcode']];
    $variables = [
      '%role_label%' => $params['invite_role_label'],
      '%role_id%' => $params['invite_role_id'],
      '%custom_message%' => $params['invite_custom_message'],
      '%user_list%' => implode(', ', $params['invite_user_list'] ?? []),
      '%address_list%' => implode("\n", $params['invite_address_list'] ?? []),
      '%login_link%' => Url::fromUserInput('/user/login', ['absolute' => TRUE])->toString(),
    ];
    $message['subject'] = $tokenService->replace(strtr($config->get($key . '_subject') ?? '', $variables), $tokens, $options);
    $rendered = $tokenService->replace(strtr($template, $variables), $tokens, $options);
    // Convert only the login link to a plain URL, no <a> tags
    $login_url = Url::fromUserInput('/user/login', ['absolute' => TRUE])->toString();
    $rendered = preg_replace(
      [
        '#<a\s+[^>]*href=["\']' . preg_quote($login_url, '#') . '["\'][^>]*>.*?</a>#is',
        '#<a\s+[^>]*href=["\']/user/login["\'][^>]*>.*?</a>#is',
      ],
      $login_url,
      $rendered
    );
    $message['body'] = ['#markup' => $rendered];
  }
}

/**
 * Implements hook_preprocess_page().
 */
function ucb_user_invite_preprocess_page(&$variables) {
  // Check if TOS acceptance is enabled in site configuration.
  $site_config = \Drupal::config('ucb_site_configuration.settings');
  $tos_enabled = $site_config->get('tos_acceptance_enabled');
  
  // If TOS acceptance is not enabled (default is FALSE), don't show the modal.
  if (empty($tos_enabled)) {
    return;
  }
  
  // Only check for logged-in users on user pages.
  $route_match = \Drupal::routeMatch();
  $route_name = $route_match->getRouteName();
  
  // Check if this is a user page route.
  if (in_array($route_name, ['entity.user.canonical', 'user.page'])) {
    $current_user = \Drupal::currentUser();
    
    // Only show modal to authenticated users.
    if ($current_user->isAuthenticated()) {
      $user = \Drupal::entityTypeManager()
        ->getStorage('user')
        ->load($current_user->id());
      
      // Check if user has accepted TOS.
      if ($user && $user->hasField('field_tos_acceptance')) {
        $tos_accepted = $user->get('field_tos_acceptance')->value;
        
        // If TOS not accepted, attach the library to show modal.
        if (empty($tos_accepted)) {
          $variables['#attached']['library'][] = 'boulder_base/ucb-tos-acceptance';
          
          // TOS URL from Web Central Website.
          $tos_url = 'https://www.colorado.edu/webcentral';
          
          // Pass settings to JavaScript.
          $variables['#attached']['drupalSettings']['ucb_tos_acceptance'] = [
            'show_modal' => TRUE,
            'tos_url' => $tos_url,
            'accept_url' => Url::fromRoute('ucb_user_invite.tos_acceptance')->toString(),
          ];
        }
      }
    }
  }
}
